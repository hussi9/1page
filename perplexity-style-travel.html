<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TravelAI â€¢ Real Perplexity Experience</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <!-- Self-contained - no external dependencies -->
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #fafbfc;
      --bg-secondary: #ffffff;
      --surface: #ffffff;
      --text-primary: #0d1421;
      --text-secondary: #586069;
      --text-tertiary: #8b949e;
      --accent: #0969da;
      --accent-light: #54aeff;
      --border: #d0d7de;
      --border-light: #f6f8fa;
      --success: #1a7f37;
      --warning: #d1242f;
      --shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
      --shadow-medium: 0 4px 16px rgba(0, 0, 0, 0.08);
      --radius: 8px;
      --radius-large: 12px;
    }

    [data-theme="dark"] {
      --bg-primary: #0d1117;
      --bg-secondary: #161b22;
      --surface: #21262d;
      --text-primary: #f0f6fc;
      --text-secondary: #8b949e;
      --text-tertiary: #656d76;
      --border: #30363d;
      --border-light: #21262d;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
    }

    .header {
      position: sticky;
      top: 0;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border);
      padding: 1rem 2rem;
      z-index: 1000;
    }

    .header-content {
      max-width: 768px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .logo {
      font-size: 1.375rem;
      font-weight: 700;
      color: var(--text-primary);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .logo-icon {
      width: 24px;
      height: 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.75rem;
      font-weight: 700;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .cost-indicator {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.375rem 0.875rem;
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .theme-toggle {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.375rem 0.875rem;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .theme-toggle:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .container {
      max-width: 768px;
      margin: 0 auto;
      padding: 2rem;
      min-height: calc(100vh - 80px);
    }

    /* Search Interface - Exact Perplexity Style */
    .search-section {
      text-align: center;
      margin-bottom: 3rem;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .search-section.compact {
      text-align: left;
      margin-bottom: 1.5rem;
    }

    .main-title {
      font-size: 2.75rem;
      font-weight: 700;
      margin-bottom: 0.75rem;
      color: var(--text-primary);
      letter-spacing: -0.025em;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .search-section.compact .main-title {
      font-size: 1.5rem;
      margin-bottom: 0;
    }

    .subtitle {
      font-size: 1.125rem;
      color: var(--text-secondary);
      margin-bottom: 2.5rem;
      font-weight: 400;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .search-section.compact .subtitle {
      display: none;
    }

    .search-container {
      position: relative;
      margin-bottom: 2rem;
    }

    .search-input {
      width: 100%;
      padding: 1.125rem 3.5rem 1.125rem 1.25rem;
      font-size: 1rem;
      border: 2px solid var(--border);
      border-radius: 24px;
      background: var(--surface);
      color: var(--text-primary);
      outline: none;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow);
      font-weight: 400;
    }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px rgba(9, 105, 218, 0.08);
      transform: translateY(-1px);
    }

    .search-input::placeholder {
      color: var(--text-tertiary);
      font-weight: 400;
    }

    .search-button {
      position: absolute;
      right: 0.5rem;
      top: 50%;
      transform: translateY(-50%);
      background: var(--accent);
      border: none;
      border-radius: 18px;
      padding: 0.625rem 1.25rem;
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.875rem;
      transition: all 0.2s ease;
      box-shadow: 0 2px 8px rgba(9, 105, 218, 0.2);
    }

    .search-button:hover {
      background: var(--accent-light);
      transform: translateY(-50%) translateY(-1px);
      box-shadow: 0 4px 12px rgba(9, 105, 218, 0.3);
    }

    .search-button:active {
      transform: translateY(-50%) translateY(0);
    }

    .search-button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: translateY(-50%);
    }

    /* Example Queries */
    .example-queries {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
      opacity: 1;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .search-section.compact .example-queries {
      opacity: 0;
      transform: translateY(-10px);
      pointer-events: none;
    }

    .example-query {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      font-size: 0.875rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
      font-weight: 500;
    }

    .example-query:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    /* Progressive Loading States - Like Perplexity */
    .search-progress {
      display: none;
      margin-bottom: 2rem;
    }

    .search-progress.show {
      display: block;
    }

    .progress-step {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.875rem 1.25rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-large);
      margin-bottom: 0.75rem;
      opacity: 0.5;
      transition: all 0.3s ease;
    }

    .progress-step.active {
      opacity: 1;
      border-color: var(--accent);
      background: rgba(9, 105, 218, 0.02);
    }

    .progress-step.completed {
      opacity: 0.7;
      border-color: var(--success);
      background: rgba(26, 127, 55, 0.02);
    }

    .progress-icon {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .progress-step .progress-icon {
      background: var(--border);
      color: var(--text-tertiary);
    }

    .progress-step.active .progress-icon {
      background: var(--accent);
      color: white;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .progress-step.completed .progress-icon {
      background: var(--success);
      color: white;
    }

    .progress-text {
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .progress-step.active .progress-text {
      color: var(--text-primary);
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }

    /* Sources Loading - Progressive like Perplexity */
    .sources-preview {
      display: none;
      margin-bottom: 2rem;
    }

    .sources-preview.show {
      display: block;
    }

    .sources-header {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sources-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 0.75rem;
    }

    .source-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 0.875rem;
      transition: all 0.3s ease;
      cursor: pointer;
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
    }

    .source-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }

    .source-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.5rem;
    }

    .source-favicon {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      background: var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      flex-shrink: 0;
    }

    .source-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .source-description {
      font-size: 0.75rem;
      color: var(--text-secondary);
      line-height: 1.4;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    @keyframes fadeInUp {
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Answer Section with Streaming Text */
    .answer-section {
      display: none;
      margin-bottom: 2rem;
    }

    .answer-section.show {
      display: block;
    }

    .answer-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.5rem;
    }

    .answer-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 0.875rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .answer-info {
      flex: 1;
    }

    .answer-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .answer-meta {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    .answer-content {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-large);
      padding: 1.75rem;
      box-shadow: var(--shadow);
      margin-bottom: 1.5rem;
    }

    .streaming-text {
      font-size: 1rem;
      line-height: 1.7;
      color: var(--text-primary);
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .cursor {
      display: inline-block;
      width: 2px;
      height: 1.2em;
      background: var(--accent);
      margin-left: 2px;
      animation: blink 1s infinite;
    }

    @keyframes blink {
      0%, 50% { opacity: 1; }
      51%, 100% { opacity: 0; }
    }

    /* Sources Section */
    .sources-section {
      display: none;
    }

    .sources-section.show {
      display: block;
    }

    .sources-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 1rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .sources-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .source-item {
      display: flex;
      align-items: center;
      gap: 0.875rem;
      padding: 0.875rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      text-decoration: none;
      color: var(--text-primary);
      transition: all 0.2s ease;
    }

    .source-item:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .source-number {
      width: 24px;
      height: 24px;
      background: var(--accent);
      color: white;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      flex-shrink: 0;
    }

    .source-content {
      flex: 1;
    }

    .source-name {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.125rem;
    }

    .source-url {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .container {
        padding: 1.5rem 1rem;
      }

      .header {
        padding: 1rem;
      }

      .main-title {
        font-size: 2.25rem;
      }

      .sources-grid {
        grid-template-columns: 1fr;
      }

      .header-controls {
        gap: 0.5rem;
      }

      .cost-indicator, .theme-toggle {
        font-size: 0.6875rem;
        padding: 0.25rem 0.625rem;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="#" class="logo">
        <div class="logo-icon">AI</div>
        TravelAI
      </a>
      <div class="header-controls">
        <div class="cost-indicator" id="costIndicator">Cache: 0 | API: 0</div>
        <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Search Interface -->
    <div class="search-section" id="searchSection">
      <h1 class="main-title">Where would you like to explore?</h1>
      <p class="subtitle">Ask me anything about travel destinations, activities, or trip planning</p>
      
      <div class="search-container">
        <input 
          type="text" 
          class="search-input" 
          id="searchInput"
          placeholder="e.g., Best hill stations near Mumbai for a weekend trip"
          onkeypress="handleKeyPress(event)"
        >
        <button class="search-button" id="searchButton" onclick="performSearch()">
          Search
        </button>
      </div>

      <div class="example-queries">
        <div class="example-query" onclick="useExampleQuery(this)">Best beaches in South India</div>
        <div class="example-query" onclick="useExampleQuery(this)">Weekend trips from Delhi under â‚¹5000</div>
        <div class="example-query" onclick="useExampleQuery(this)">Hill stations for monsoon travel</div>
        <div class="example-query" onclick="useExampleQuery(this)">Family places in Kerala</div>
      </div>
    </div>

    <!-- Progressive Loading Steps -->
    <div class="search-progress" id="searchProgress">
      <div class="progress-step" id="step1">
        <div class="progress-icon">1</div>
        <div class="progress-text">Searching travel databases...</div>
      </div>
      <div class="progress-step" id="step2">
        <div class="progress-icon">2</div>
        <div class="progress-text">Finding relevant destinations...</div>
      </div>
      <div class="progress-step" id="step3">
        <div class="progress-icon">3</div>
        <div class="progress-text">Analyzing travel data...</div>
      </div>
      <div class="progress-step" id="step4">
        <div class="progress-icon">4</div>
        <div class="progress-text">Generating personalized recommendations...</div>
      </div>
    </div>

    <!-- Sources Preview (loads progressively) -->
    <div class="sources-preview" id="sourcesPreview">
      <div class="sources-header">Sources</div>
      <div class="sources-grid" id="sourcesGrid">
        <!-- Sources will load here progressively -->
      </div>
    </div>

    <!-- Answer Section with Streaming Text -->
    <div class="answer-section" id="answerSection">
      <div class="answer-header">
        <div class="answer-avatar">AI</div>
        <div class="answer-info">
          <div class="answer-title">Travel Recommendations</div>
          <div class="answer-meta" id="answerMeta">Generated with Claude AI</div>
        </div>
      </div>
      
      <div class="answer-content">
        <div class="streaming-text" id="streamingText"></div>
      </div>
    </div>

    <!-- Final Sources Section -->
    <div class="sources-section" id="sourcesSection">
      <div class="sources-title">Sources</div>
      <div class="sources-list" id="sourcesList">
        <!-- Final sources will appear here -->
      </div>
    </div>
  </div>

  <script>
    // ðŸŽ­ REAL PERPLEXITY-STYLE STREAMING INTERFACE
    
    // API Configuration
    const ANTHROPIC_API_KEY = localStorage.getItem('ANTHROPIC_API_KEY') || 
      prompt('Enter your Claude API key for AI answers:');
    const CLAUDE_API_URL = 'https://api.anthropic.com/v1/messages';
    
    if (ANTHROPIC_API_KEY && !localStorage.getItem('ANTHROPIC_API_KEY')) {
      localStorage.setItem('ANTHROPIC_API_KEY', ANTHROPIC_API_KEY);
    }
    
    // Cost tracking
    let dailyApiCalls = parseInt(localStorage.getItem('dailyApiCalls') || '0');
    let dailyCacheHits = parseInt(localStorage.getItem('dailyCacheHits') || '0');
    
    // State
    let currentQuery = '';
    let isSearching = false;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ðŸŽ­ Perplexity-style TravelAI initialized');
      document.getElementById('searchInput').focus();
      updateCostDisplay();
    });

    // ðŸ” MAIN SEARCH FUNCTION WITH PROGRESSIVE UI
    async function performSearch() {
      if (isSearching) return;
      
      const query = document.getElementById('searchInput').value.trim();
      if (!query) return;

      currentQuery = query;
      isSearching = true;
      
      // Transform UI to compact mode
      transformToCompactMode();
      
      try {
        // Step 1: Start progressive loading
        startProgressiveSearch();
        
        // Step 2: Check cache first
        await simulateStep(1, 'Checking cached responses...');
        const cachedAnswer = await checkCache(query);
        
        if (cachedAnswer) {
          await simulateStep(2, 'Found cached response!');
          await simulateStep(3, 'Preparing answer...');
          await simulateStep(4, 'Ready to display!');
          
          displayCachedResponse(cachedAnswer);
          dailyCacheHits++;
          localStorage.setItem('dailyCacheHits', dailyCacheHits.toString());
          updateCostDisplay();
          return;
        }
        
        // Step 3: Gather travel data
        await simulateStep(2, 'Gathering fresh travel data...');
        const travelData = await gatherTravelData(query);
        
        // Step 4: Show sources progressively
        await simulateStep(3, 'Found ' + travelData.length + ' relevant sources...');
        await showSourcesProgressively(travelData);
        
        // Step 5: Generate AI answer
        await simulateStep(4, 'Generating AI response...');
        const aiAnswer = await generateClaudeAnswer(query, travelData);
        
        // Step 6: Stream the answer
        await streamAnswer(aiAnswer);
        
        // Step 7: Cache for future use
        await cacheResponse(query, aiAnswer, travelData);
        
        // Update API usage
        dailyApiCalls++;
        localStorage.setItem('dailyApiCalls', dailyApiCalls.toString());
        updateCostDisplay();
        
      } catch (error) {
        console.error('Search failed:', error);
        await streamAnswer('Sorry, I encountered an error while searching for travel information. Please try again.');
      } finally {
        isSearching = false;
        hideProgressiveSearch();
      }
    }

    // ðŸŽ¬ PROGRESSIVE UI ANIMATIONS
    function transformToCompactMode() {
      const searchSection = document.getElementById('searchSection');
      searchSection.classList.add('compact');
      
      // Update search input
      document.getElementById('searchInput').value = currentQuery;
    }

    function startProgressiveSearch() {
      document.getElementById('searchProgress').classList.add('show');
      resetProgressSteps();
    }

    function hideProgressiveSearch() {
      setTimeout(() => {
        document.getElementById('searchProgress').classList.remove('show');
      }, 1000);
    }

    function resetProgressSteps() {
      for (let i = 1; i <= 4; i++) {
        const step = document.getElementById(`step${i}`);
        step.classList.remove('active', 'completed');
      }
    }

    async function simulateStep(stepNum, text) {
      const step = document.getElementById(`step${stepNum}`);
      const textEl = step.querySelector('.progress-text');
      
      // Mark previous steps as completed
      for (let i = 1; i < stepNum; i++) {
        document.getElementById(`step${i}`).classList.add('completed');
        document.getElementById(`step${i}`).classList.remove('active');
      }
      
      // Activate current step
      step.classList.add('active');
      textEl.textContent = text;
      
      // Simulate processing time
      await new Promise(resolve => setTimeout(resolve, 800 + Math.random() * 400));
    }

    // ðŸ“š PROGRESSIVE SOURCE LOADING
    async function showSourcesProgressively(travelData) {
      const sourcesPreview = document.getElementById('sourcesPreview');
      const sourcesGrid = document.getElementById('sourcesGrid');
      
      sourcesPreview.classList.add('show');
      sourcesGrid.innerHTML = '';
      
      // Add sources one by one with delay
      for (let i = 0; i < Math.min(travelData.length, 4); i++) {
        await new Promise(resolve => setTimeout(resolve, 300));
        
        const source = travelData[i];
        const sourceCard = createSourceCard(source, i);
        sourcesGrid.appendChild(sourceCard);
      }
    }

    function createSourceCard(source, index) {
      const card = document.createElement('div');
      card.className = 'source-card';
      card.style.animationDelay = `${index * 0.1}s`;
      
      card.innerHTML = `
        <div class="source-header">
          <div class="source-favicon">${getSourceIcon(source.source)}</div>
          <div class="source-title">${source.name}</div>
        </div>
        <div class="source-description">${source.description || 'Travel destination information'}</div>
      `;
      
      return card;
    }

    function getSourceIcon(source) {
      const icons = {
        'mongodb': 'ðŸ—„ï¸',
        'geoapify': 'ðŸ“',
        'tripadvisor': 'ðŸ¨',
        'openstreetmap': 'ðŸ—ºï¸'
      };
      return icons[source] || 'ðŸŒ';
    }

    // âŒ¨ï¸ STREAMING TEXT EFFECT
    async function streamAnswer(text) {
      const answerSection = document.getElementById('answerSection');
      const streamingText = document.getElementById('streamingText');
      const answerMeta = document.getElementById('answerMeta');
      
      answerSection.classList.add('show');
      streamingText.innerHTML = '';
      
      // Update metadata
      answerMeta.textContent = dailyApiCalls > 0 ? 
        `Generated with Claude AI â€¢ ~â‚¹${(dailyApiCalls * 0.5).toFixed(1)}` : 
        'From cached response â€¢ â‚¹0';
      
      // Stream text character by character
      const cursor = document.createElement('span');
      cursor.className = 'cursor';
      streamingText.appendChild(cursor);
      
      const words = text.split(' ');
      let currentText = '';
      
      for (let i = 0; i < words.length; i++) {
        currentText += (i > 0 ? ' ' : '') + words[i];
        streamingText.textContent = currentText;
        streamingText.appendChild(cursor);
        
        // Variable speed - faster for common words
        const delay = words[i].length > 6 ? 80 : 40;
        await new Promise(resolve => setTimeout(resolve, delay + Math.random() * 30));
      }
      
      // Remove cursor after completion
      setTimeout(() => {
        cursor.remove();
        showFinalSources();
      }, 1000);
    }

    function showFinalSources() {
      // Hide sources preview and show final sources
      document.getElementById('sourcesPreview').style.display = 'none';
      document.getElementById('sourcesSection').classList.add('show');
    }

    // ðŸ§  AI AND DATA FUNCTIONS
    async function generateClaudeAnswer(query, travelData) {
      if (!ANTHROPIC_API_KEY) {
        return `Based on your search for "${query}", here are some great travel recommendations from our database. ${travelData.slice(0, 3).map(d => d.name).join(', ')} are popular destinations that match your criteria.`;
      }
      
      try {
        const optimizedPrompt = `Travel Query: "${query}"

Available destinations:
${travelData.slice(0, 5).map(d => `â€¢ ${d.name}: ${d.description || 'Popular destination'} (${d.distance || 'nearby'})`).join('\n')}

Provide a helpful, conversational travel answer in 4-5 sentences. Include specific destination names and practical advice.`;

        const response = await fetch(CLAUDE_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'x-api-key': ANTHROPIC_API_KEY,
            'anthropic-version': '2023-06-01'
          },
          body: JSON.stringify({
            model: 'claude-3-haiku-20240307',
            max_tokens: 400,
            messages: [{ role: 'user', content: optimizedPrompt }]
          })
        });

        if (!response.ok) {
          throw new Error(`Claude API failed: ${response.status}`);
        }

        const data = await response.json();
        return data.content[0].text;
        
      } catch (error) {
        console.error('Claude API error:', error);
        return `Based on your search for "${query}", here are some excellent travel recommendations. ${travelData.slice(0, 3).map(d => d.name).join(', ')} are wonderful destinations that would be perfect for your trip.`;
      }
    }

    async function gatherTravelData(query) {
      try {
        console.log(`ðŸ” Searching for: "${query}"`);
        
        // Extract location and coordinates
        const location = extractLocationFromQuery(query);
        const searchCoords = getDefaultCoordinates(location || 'mumbai');
        const [lat, lng] = searchCoords;
        
        console.log(`ðŸ“ Search coordinates: ${lat}, ${lng} (${location || 'default'})`);
        
        // First try to get intelligent curated results based on query
        const curatedResults = getCuratedResults(query, location);
        if (curatedResults.length > 0) {
          console.log(`âœ… Using curated results for "${query}"`);
          return curatedResults;
        }
        
        // Try OpenStreetMap for real places
        const osmResults = await searchOpenStreetMapDirect(lat, lng, query);
        if (osmResults.length > 0 && osmResults.every(r => r.name !== 'Unnamed Place')) {
          console.log(`âœ… Found ${osmResults.length} results from OpenStreetMap`);
          return osmResults;
        }
        
        // Final fallback - generate contextual results
        console.log(`âš ï¸ Using smart fallback data for "${query}"`);
        return generateSmartFallback(query, location);
        
      } catch (error) {
        console.error('âŒ Data gathering failed:', error);
        return generateSmartFallback(query, null);
      }
    }
    
    // DIRECT GEOAPIFY API SEARCH
    async function searchGeoapifyDirect(lat, lng, query) {
      try {
        const apiKey = '3bc64d2366df476b942c00221c34170e'; // Your provided key
        const categories = getQueryCategories(query);
        const radius = getQueryRadius(query);
        
        const url = `https://api.geoapify.com/v2/places?categories=${categories}&filter=circle:${lng},${lat},${radius}&bias=proximity:${lng},${lat}&limit=20&apiKey=${apiKey}`;
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error(`Geoapify API failed: ${response.status}`);
        }
        
        const data = await response.json();
        
        return data.features.map(feature => {
          const props = feature.properties;
          const coords = feature.geometry.coordinates;
          const distance = calculateDistance([lat, lng], [coords[1], coords[0]]);
          
          return {
            name: props.name || 'Unknown Place',
            description: props.description || generateDescription(props.categories?.[0], query),
            distance: `${Math.round(distance)}km`,
            cost: Math.round(distance * 15) + 400,
            coordinates: [coords[1], coords[0]],
            category: props.categories?.[0] || 'tourism',
            rating: props.rating || (4.0 + Math.random()),
            source: 'geoapify',
            image: null // Geoapify doesn't provide images in free tier
          };
        }).slice(0, 8);
        
      } catch (error) {
        console.error('Geoapify search failed:', error);
        return [];
      }
    }
    
    // DIRECT OPENSTREETMAP SEARCH
    async function searchOpenStreetMapDirect(lat, lng, query) {
      try {
        const radius = getQueryRadius(query);
        const osmQuery = `
          [out:json][timeout:20];
          (
            node["tourism"~"attraction|museum|viewpoint|picnic_site|zoo|theme_park|aquarium|artwork|gallery"](around:${radius},${lat},${lng});
            node["leisure"~"park|nature_reserve|beach_resort|water_park|garden|golf_course|marina"](around:${radius},${lat},${lng});
            node["natural"~"beach|peak|waterfall|hot_spring|cave_entrance|rock|cliff"](around:${radius},${lat},${lng});
            node["historic"~"castle|fort|monument|ruins|archaeological_site"](around:${radius},${lat},${lng});
            way["tourism"~"attraction|museum|viewpoint|zoo|theme_park"](around:${radius},${lat},${lng});
            way["leisure"~"park|nature_reserve|water_park|garden"](around:${radius},${lat},${lng});
            way["natural"~"beach|peak|waterfall"](around:${radius},${lat},${lng});
          );
          out center meta;
        `;
        
        const response = await fetch('https://overpass-api.de/api/interpreter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: `data=${encodeURIComponent(osmQuery)}`
        });
        
        if (!response.ok) {
          throw new Error(`OpenStreetMap API failed: ${response.status}`);
        }
        
        const data = await response.json();
        
        return data.elements.map(element => {
          const elementLat = element.lat || element.center?.lat;
          const elementLon = element.lon || element.center?.lon;
          const distance = calculateDistance([lat, lng], [elementLat, elementLon]);
          
          return {
            name: element.tags?.name || 'Unnamed Place',
            description: element.tags?.description || generateDescription(element.tags?.tourism || element.tags?.leisure, query),
            distance: `${Math.round(distance)}km`,
            cost: Math.round(distance * 12) + 300,
            coordinates: [elementLat, elementLon],
            category: element.tags?.tourism || element.tags?.leisure || 'place',
            rating: 4.0 + Math.random() * 0.8,
            source: 'openstreetmap'
          };
        }).filter(place => place.coordinates[0] && place.coordinates[1])
          .sort((a, b) => parseFloat(a.distance) - parseFloat(b.distance))
          .slice(0, 10);
        
      } catch (error) {
        console.error('OpenStreetMap search failed:', error);
        return [];
      }
    }

    function transformMongoResults(mongoResults) {
      return mongoResults.slice(0, 6).map(dest => ({
        name: dest.name,
        description: dest.description,
        distance: dest.details?.duration?.travel ? `${Math.floor(dest.details.duration.travel / 60)}h` : '2-3h',
        cost: dest.details?.cost?.average || 500,
        source: 'mongodb'
      }));
    }

    function extractLocationFromQuery(query) {
      const locations = {
        'mumbai': ['mumbai', 'bombay'],
        'delhi': ['delhi', 'new delhi'],
        'bangalore': ['bangalore', 'bengaluru'],
        'chennai': ['chennai', 'madras'],
        'kerala': ['kerala', 'kochi', 'cochin', 'thiruvananthapuram'],
        'goa': ['goa', 'panaji'],
        'rajasthan': ['rajasthan', 'jaipur', 'udaipur', 'jodhpur'],
        'himachal': ['himachal', 'shimla', 'manali'],
        'uttarakhand': ['uttarakhand', 'dehradun', 'mussoorie', 'rishikesh'],
        'maharashtra': ['pune', 'nashik', 'aurangabad', 'thane']
      };
      
      const lowerQuery = query.toLowerCase();
      
      for (const [state, cities] of Object.entries(locations)) {
        for (const city of cities) {
          if (lowerQuery.includes(city)) {
            return state;
          }
        }
      }
      
      // Try to extract location patterns like "near X" or "from X"
      const nearMatch = lowerQuery.match(/(?:near|from|in)\s+([a-z\s]+)/);
      if (nearMatch) {
        const extractedLocation = nearMatch[1].trim();
        for (const [state, cities] of Object.entries(locations)) {
          if (cities.some(city => extractedLocation.includes(city))) {
            return state;
          }
        }
      }
      
      return null;
    }
    
    function getDefaultCoordinates(location) {
      const coordinates = {
        'mumbai': [19.0760, 72.8777],
        'delhi': [28.6139, 77.2090],
        'bangalore': [12.9716, 77.5946],
        'chennai': [13.0827, 80.2707],
        'kerala': [10.8505, 76.2711],
        'goa': [15.2993, 74.1240],
        'rajasthan': [26.9124, 75.7873],
        'himachal': [31.1048, 77.1734],
        'uttarakhand': [30.0668, 79.0193],
        'maharashtra': [19.2183, 72.9781]
      };
      return coordinates[location] || coordinates['mumbai'];
    }
    
    function transformAPIResults(apiResults, query) {
      return apiResults.slice(0, 12).map(place => ({
        name: place.name,
        description: place.description || `${place.type} destination`,
        distance: `${place.distance}km`,
        cost: Math.round(place.distance * 10) + 300, // Estimate cost based on distance
        image: place.image || place.photos?.[0],
        rating: place.rating || 4.2,
        reviews: place.reviews || 0,
        source: place.source,
        coordinates: place.coordinates
      }));
    }
    
    // HELPER FUNCTIONS FOR API SEARCHES
    function getQueryCategories(query) {
      const lowerQuery = query.toLowerCase();
      
      if (lowerQuery.includes('temple') || lowerQuery.includes('church') || lowerQuery.includes('mosque')) {
        return 'religion';
      }
      if (lowerQuery.includes('museum') || lowerQuery.includes('gallery') || lowerQuery.includes('art')) {
        return 'entertainment';
      }
      if (lowerQuery.includes('park') || lowerQuery.includes('garden') || lowerQuery.includes('nature')) {
        return 'leisure';
      }
      if (lowerQuery.includes('beach') || lowerQuery.includes('hill') || lowerQuery.includes('mountain')) {
        return 'natural';
      }
      if (lowerQuery.includes('fort') || lowerQuery.includes('palace') || lowerQuery.includes('monument')) {
        return 'tourism.sights';
      }
      
      return 'tourism'; // Default category
    }
    
    function getQueryRadius(query) {
      const lowerQuery = query.toLowerCase();
      
      if (lowerQuery.includes('nearby') || lowerQuery.includes('close')) {
        return 25000; // 25km
      }
      if (lowerQuery.includes('weekend') || lowerQuery.includes('day trip')) {
        return 150000; // 150km
      }
      if (lowerQuery.includes('state') || lowerQuery.includes('region')) {
        return 300000; // 300km
      }
      
      return 100000; // Default 100km
    }
    
    function generateDescription(category, query) {
      const descriptions = {
        'tourism': 'Popular tourist attraction',
        'leisure': 'Relaxing recreational spot',
        'entertainment': 'Cultural and entertainment venue',
        'religion': 'Sacred religious site',
        'natural': 'Beautiful natural landmark',
        'attraction': 'Must-visit destination',
        'museum': 'Educational and cultural museum',
        'park': 'Scenic park and recreation area',
        'monument': 'Historic monument and landmark'
      };
      
      return descriptions[category] || 'Interesting place to visit';
    }
    
    function calculateDistance(coord1, coord2) {
      const R = 6371; // Earth's radius in km
      const dLat = (coord2[0] - coord1[0]) * Math.PI / 180;
      const dLon = (coord2[1] - coord1[1]) * Math.PI / 180;
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(coord1[0] * Math.PI / 180) * Math.cos(coord2[0] * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    
    // COMPREHENSIVE CURATED TRAVEL DATABASE
    const TRAVEL_DATABASE = {
      // Hill Stations
      hill: {
        'chennai': [
          { name: 'Ooty', desc: 'Queen of Hill Stations in Nilgiris', distance: 280, cost: 2500, rating: 4.5 },
          { name: 'Kodaikanal', desc: 'Princess of Hill Stations', distance: 320, cost: 2800, rating: 4.4 },
          { name: 'Yercaud', desc: 'Jewel of the South', distance: 230, cost: 2200, rating: 4.2 },
          { name: 'Kotagiri', desc: 'Peaceful tea town', distance: 270, cost: 2400, rating: 4.1 },
          { name: 'Coonoor', desc: 'Gateway to Nilgiris', distance: 285, cost: 2600, rating: 4.3 }
        ],
        'mumbai': [
          { name: 'Lonavala', desc: 'Monsoon paradise near Mumbai', distance: 83, cost: 1500, rating: 4.2 },
          { name: 'Mahabaleshwar', desc: 'Strawberry capital of India', distance: 120, cost: 2000, rating: 4.4 },
          { name: 'Matheran', desc: 'Car-free hill station', distance: 90, cost: 1800, rating: 4.1 },
          { name: 'Khandala', desc: 'Twin hill station with Lonavala', distance: 85, cost: 1600, rating: 4.0 },
          { name: 'Panchgani', desc: 'Table Land hill station', distance: 100, cost: 1900, rating: 4.2 }
        ],
        'delhi': [
          { name: 'Shimla', desc: 'Colonial hill station capital', distance: 350, cost: 3500, rating: 4.5 },
          { name: 'Manali', desc: 'Adventure capital of Himachal', distance: 550, cost: 4500, rating: 4.6 },
          { name: 'Mussoorie', desc: 'Queen of the Hills', distance: 280, cost: 3000, rating: 4.3 },
          { name: 'Nainital', desc: 'Lake district of India', distance: 320, cost: 3200, rating: 4.4 },
          { name: 'Kasauli', desc: 'Peaceful cantonment town', distance: 300, cost: 2800, rating: 4.1 }
        ]
      },
      
      // Beaches
      beach: {
        'chennai': [
          { name: 'Marina Beach', desc: 'World\'s second longest beach', distance: 5, cost: 500, rating: 4.0 },
          { name: 'Pondicherry Beach', desc: 'French colonial seaside', distance: 160, cost: 2000, rating: 4.3 },
          { name: 'Mahabalipuram Beach', desc: 'UNESCO World Heritage site', distance: 60, cost: 1200, rating: 4.4 },
          { name: 'Covelong Beach', desc: 'Surfing destination', distance: 40, cost: 1000, rating: 4.1 },
          { name: 'Kanyakumari Beach', desc: 'Southernmost tip of India', distance: 700, cost: 4000, rating: 4.5 }
        ],
        'mumbai': [
          { name: 'Juhu Beach', desc: 'Bollywood\'s favorite beach', distance: 18, cost: 800, rating: 3.8 },
          { name: 'Alibag Beach', desc: 'Weekend getaway beach', distance: 95, cost: 1800, rating: 4.2 },
          { name: 'Kashid Beach', desc: 'White sand paradise', distance: 135, cost: 2200, rating: 4.4 },
          { name: 'Murud Beach', desc: 'Historic coastal town', distance: 150, cost: 2500, rating: 4.1 },
          { name: 'Tarkarli Beach', desc: 'Pristine Konkan coast', distance: 460, cost: 4200, rating: 4.6 }
        ],
        'kerala': [
          { name: 'Varkala Beach', desc: 'Cliff-top beach paradise', distance: 50, cost: 1500, rating: 4.5 },
          { name: 'Kovalam Beach', desc: 'Crescent-shaped beach', distance: 15, cost: 1200, rating: 4.3 },
          { name: 'Marari Beach', desc: 'Secluded fishing village', distance: 85, cost: 2000, rating: 4.4 },
          { name: 'Cherai Beach', desc: 'Golden sand beach', distance: 35, cost: 1400, rating: 4.2 },
          { name: 'Bekal Beach', desc: 'Historic fort beach', distance: 320, cost: 3500, rating: 4.3 }
        ]
      },
      
      // Weekend Trips
      weekend: {
        'delhi': [
          { name: 'Agra', desc: 'Taj Mahal and Mughal heritage', distance: 230, cost: 2500, rating: 4.7 },
          { name: 'Jaipur', desc: 'Pink City of Rajasthan', distance: 280, cost: 3000, rating: 4.5 },
          { name: 'Rishikesh', desc: 'Yoga capital of the world', distance: 240, cost: 2200, rating: 4.4 },
          { name: 'Jim Corbett', desc: 'Tiger reserve national park', distance: 160, cost: 3500, rating: 4.3 },
          { name: 'Amritsar', desc: 'Golden Temple city', distance: 450, cost: 4000, rating: 4.6 }
        ],
        'mumbai': [
          { name: 'Goa', desc: 'Beach capital of India', distance: 470, cost: 4500, rating: 4.5 },
          { name: 'Pune', desc: 'Cultural capital of Maharashtra', distance: 150, cost: 1800, rating: 4.1 },
          { name: 'Nashik', desc: 'Wine country of India', distance: 180, cost: 2200, rating: 4.2 },
          { name: 'Aurangabad', desc: 'Ajanta and Ellora caves', distance: 350, cost: 3200, rating: 4.4 },
          { name: 'Udaipur', desc: 'City of Lakes', distance: 650, cost: 5000, rating: 4.6 }
        ]
      },
      
      // Family Places
      family: {
        'kerala': [
          { name: 'Munnar', desc: 'Tea plantation hills', distance: 130, cost: 2800, rating: 4.5 },
          { name: 'Alleppey Backwaters', desc: 'Houseboat experience', distance: 65, cost: 3500, rating: 4.6 },
          { name: 'Thekkady', desc: 'Periyar wildlife sanctuary', distance: 190, cost: 2500, rating: 4.3 },
          { name: 'Wayanad', desc: 'Hill station with waterfalls', distance: 76, cost: 2200, rating: 4.4 },
          { name: 'Kumarakom', desc: 'Bird sanctuary backwaters', distance: 85, cost: 3000, rating: 4.2 }
        ],
        'mumbai': [
          { name: 'Imagica Theme Park', desc: 'Adventure theme park', distance: 76, cost: 2500, rating: 4.2 },
          { name: 'Lavasa', desc: 'Planned hill city', distance: 65, cost: 2000, rating: 4.0 },
          { name: 'Sinhagad Fort', desc: 'Historic fort near Pune', distance: 170, cost: 1500, rating: 4.1 },
          { name: 'Della Adventure Park', desc: 'Adventure activities', distance: 85, cost: 2200, rating: 4.2 },
          { name: 'Rajmachi Fort', desc: 'Trekking destination', distance: 95, cost: 1800, rating: 4.3 }
        ]
      }
    };
    
    function getCuratedResults(query, location) {
      const lowerQuery = query.toLowerCase();
      
      // Determine query type and location
      let queryType = null;
      let searchLocation = location || 'mumbai';
      
      if (lowerQuery.includes('hill') || lowerQuery.includes('mountain')) queryType = 'hill';
      else if (lowerQuery.includes('beach')) queryType = 'beach';
      else if (lowerQuery.includes('weekend')) queryType = 'weekend';
      else if (lowerQuery.includes('family')) queryType = 'family';
      
      // Get results from database
      if (queryType && TRAVEL_DATABASE[queryType] && TRAVEL_DATABASE[queryType][searchLocation]) {
        return TRAVEL_DATABASE[queryType][searchLocation].map(place => ({
          name: place.name,
          description: place.desc,
          distance: `${place.distance}km`,
          cost: place.cost,
          rating: place.rating,
          source: 'curated_database'
        }));
      }
      
      // Fallback to general location-based results
      const allResults = [];
      Object.values(TRAVEL_DATABASE).forEach(category => {
        if (category[searchLocation]) {
          allResults.push(...category[searchLocation]);
        }
      });
      
      if (allResults.length > 0) {
        return allResults.slice(0, 6).map(place => ({
          name: place.name,
          description: place.desc,
          distance: `${place.distance}km`,
          cost: place.cost,
          rating: place.rating,
          source: 'curated_database'
        }));
      }
      
      return [];
    }
    
    function generateSmartFallback(query, location) {
      // This should never be called now, but keeping as final safety net
      return getCuratedResults(query, location) || [
        { name: 'Mumbai', description: 'Financial capital of India', distance: '0km', cost: 1000, rating: 4.2, source: 'fallback' },
        { name: 'Delhi', description: 'Capital city of India', distance: '100km', cost: 1500, rating: 4.1, source: 'fallback' },
        { name: 'Bangalore', description: 'Silicon Valley of India', distance: '200km', cost: 2000, rating: 4.3, source: 'fallback' }
      ];
    }

    // ðŸ’¾ CACHING FUNCTIONS
    async function checkCache(query) {
      try {
        const cacheKey = generateCacheKey(query);
        const response = await window.RealProductionTravelAPI.makeMongoRequest('find', {
          collection: 'perplexity_cache',
          filter: {
            cache_key: cacheKey,
            'meta.expires_at': { $gt: new Date().toISOString() }
          },
          limit: 1
        });
        
        return response.documents?.[0] || null;
      } catch (error) {
        console.error('Cache check failed:', error);
        return null;
      }
    }

    async function cacheResponse(query, answer, travelData) {
      try {
        const cacheKey = generateCacheKey(query);
        const expiryDate = new Date();
        expiryDate.setHours(expiryDate.getHours() + 24);
        
        const cacheDocument = {
          cache_key: cacheKey,
          query: query,
          ai_answer: answer,
          travel_data: travelData.slice(0, 5),
          meta: {
            created_at: new Date().toISOString(),
            expires_at: expiryDate.toISOString()
          }
        };
        
        await window.RealProductionTravelAPI.makeMongoRequest('insertOne', {
          collection: 'perplexity_cache',
          document: cacheDocument
        });
      } catch (error) {
        console.error('Failed to cache response:', error);
      }
    }

    function generateCacheKey(query) {
      return query.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, '_') + '_perplexity';
    }

    async function displayCachedResponse(cachedData) {
      await showSourcesProgressively(cachedData.travel_data || []);
      await streamAnswer(cachedData.ai_answer);
      
      // Update final sources
      setTimeout(() => {
        const sourcesList = document.getElementById('sourcesList');
        sourcesList.innerHTML = (cachedData.travel_data || []).map((source, index) => `
          <div class="source-item">
            <div class="source-number">${index + 1}</div>
            <div class="source-content">
              <div class="source-name">${source.name}</div>
              <div class="source-url">${source.source || 'Travel Database'}</div>
            </div>
          </div>
        `).join('');
      }, 2000);
    }

    // ðŸŽ¨ UI HELPERS
    function updateCostDisplay() {
      const costIndicator = document.getElementById('costIndicator');
      costIndicator.textContent = `Cache: ${dailyCacheHits} | API: ${dailyApiCalls}`;
    }

    function handleKeyPress(event) {
      if (event.key === 'Enter' && !isSearching) {
        performSearch();
      }
    }

    function useExampleQuery(element) {
      if (isSearching) return;
      document.getElementById('searchInput').value = element.textContent;
      performSearch();
    }

    function toggleTheme() {
      const body = document.body;
      const currentTheme = body.getAttribute('data-theme');
      const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
      body.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
      document.body.setAttribute('data-theme', savedTheme);
    }
  </script>
</body>
</html>